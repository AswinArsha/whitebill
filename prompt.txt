import React, { useState, useEffect } from 'react';
import { useParams } from 'react-router-dom';
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from "@/components/ui/table";
import { Badge } from "@/components/ui/badge";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { Calendar as CalendarIcon, Clock, UserCheck, AlertTriangle } from "lucide-react";
import { supabase } from "../supabase";
import { format, parseISO } from 'date-fns';

const IndividualAttendanceReport = () => {
  const { id } = useParams(); // Get staff_id from route parameters
  const [selectedMonth, setSelectedMonth] = useState(() => {
    const now = new Date();
    return format(now, 'MMMM yyyy');
  });
  const [staffMember, setStaffMember] = useState(null);
  const [attendanceStats, setAttendanceStats] = useState({
    daysPresent: 0,
    daysAbsent: 0,
    daysLate: 0,
    averageCheckInTime: '-',
  });
  const [attendanceData, setAttendanceData] = useState([]);
  const [calendarData, setCalendarData] = useState([]);

  const officeStartTime = "10:00"; // Adjust based on your office start time

  useEffect(() => {
    if (id) {
      fetchStaffDetails();
      fetchAttendanceDetails();
    }
  }, [id, selectedMonth]);

  const fetchStaffDetails = async () => {
    const { data, error } = await supabase
      .from('staff')
      .select('*')
      .eq('id', id)
      .single();

    if (error) {
      console.error("Error fetching staff details:", error);
      return;
    }

    setStaffMember(data);
  };

  const fetchAttendanceDetails = async () => {
    // Parse selectedMonth to get the first and last day of the month
    const [month, year] = selectedMonth.split(' ');
    const firstDay = new Date(`${month} 1, ${year}`);
    const lastDay = new Date(firstDay.getFullYear(), firstDay.getMonth() + 1, 0);

    const { data, error } = await supabase
      .from('attendance')
      .select('date, time')
      .eq('staff_id', id)
      .gte('date', format(firstDay, 'yyyy-MM-dd'))
      .lte('date', format(lastDay, 'yyyy-MM-dd'));

    if (error) {
      console.error("Error fetching attendance details:", error);
      return;
    }

    // Organize attendance records by date
    const attendanceMap = {};
    data.forEach(record => {
      const dateStr = format(parseISO(record.date), 'yyyy-MM-dd');
      if (!attendanceMap[dateStr]) {
        attendanceMap[dateStr] = [];
      }
      attendanceMap[dateStr].push(record.time);
    });

    // Generate a list of all dates in the selected month
    const daysInMonth = lastDay.getDate();
    const tempAttendanceData = [];
    let daysPresent = 0;
    let daysAbsent = 0;
    let daysLate = 0;
    let totalCheckInMinutes = 0;
    let checkInCount = 0;

    const tempCalendarData = [];

    for (let day = 1; day <= daysInMonth; day++) {
      const currentDate = new Date(firstDay.getFullYear(), firstDay.getMonth(), day);
      const dateStr = format(currentDate, 'yyyy-MM-dd');

      const records = attendanceMap[dateStr] || [];
      let checkIn = '-';
      let checkOut = '-';
      let status = 'Absent';

      if (records.length > 0) {
        // Assume first record is check-in and last record is check-out
        checkIn = formatTime(records[0]);
        checkOut = formatTime(records[records.length - 1]);

        // Determine status based on check-in time
        if (records[0] <= officeStartTime) {
          status = 'Present';
          daysPresent += 1;
        } else {
          status = 'Late';
          daysLate += 1;
        }

        // Calculate total check-in time for average
        const checkInMinutes = convertTimeToMinutes(records[0]);
        totalCheckInMinutes += checkInMinutes;
        checkInCount += 1;
      } else {
        daysAbsent += 1;
      }

      tempAttendanceData.push({
        date: dateStr,
        checkIn,
        checkOut,
        status,
      });

      // Prepare data for calendar
      tempCalendarData.push({
        date: day,
        status: status.toLowerCase(),
      });
    }

    // Calculate average check-in time
    const averageCheckInTime = checkInCount > 0
      ? formatMinutesToTime(Math.round(totalCheckInMinutes / checkInCount))
      : '-';

    setAttendanceStats({
      daysPresent,
      daysAbsent,
      daysLate,
      averageCheckInTime,
    });

    setAttendanceData(tempAttendanceData);
    setCalendarData(tempCalendarData);
  };

  const formatTime = (timeStr) => {
    // Convert "HH:MM" to "HH:MM AM/PM"
    const [hour, minute] = timeStr.split(':');
    const date = new Date();
    date.setHours(parseInt(hour), parseInt(minute));
    return format(date, 'hh:mm a');
  };

  const convertTimeToMinutes = (timeStr) => {
    const [hour, minute] = timeStr.split(':').map(Number);
    return hour * 60 + minute;
  };

  const formatMinutesToTime = (totalMinutes) => {
    const hours = Math.floor(totalMinutes / 60);
    const minutes = totalMinutes % 60;
    const date = new Date();
    date.setHours(hours, minutes);
    return format(date, 'hh:mm a');
  };

  const generateMonthOptions = () => {
    const options = [];
    const currentDate = new Date();
    for (let i = 0; i < 12; i++) {
      const date = new Date(currentDate.getFullYear(), currentDate.getMonth() - i, 1);
      options.push(format(date, 'MMMM yyyy'));
    }
    return options;
  };

  if (!staffMember) {
    return <div className="container mx-auto p-4">Loading...</div>;
  }

  return (
    <div className="container ">
      {/* Header */}
      <div className="flex flex-col md:flex-row justify-between items-start md:items-center mb-8">
        <div>
          <h1 className="text-xl font-bold">{staffMember.name}</h1>
          <p className="text-muted-foreground">
           {staffMember.position}, {staffMember.department}
          </p>
        </div>
        <Select value={selectedMonth} onValueChange={setSelectedMonth}>
          <SelectTrigger className="w-[180px] mt-4 md:mt-0">
            <SelectValue placeholder="Select month" />
          </SelectTrigger>
          <SelectContent>
            {generateMonthOptions().map((month) => (
              <SelectItem key={month} value={month}>
                {month}
              </SelectItem>
            ))}
          </SelectContent>
        </Select>
      </div>

      {/* Attendance Statistics */}
      <div className="grid gap-4 md:grid-cols-2 lg:grid-cols-4 mb-8">
        <Card className="">
          <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
            <CardTitle className="text-sm font-medium">Days Present</CardTitle>
            <UserCheck className="h-4 w-4 text-green-600" />
          </CardHeader>
          <CardContent>
            <div className="text-2xl font-bold">{attendanceStats.daysPresent}</div>
          </CardContent>
        </Card>
        <Card className="">
          <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
            <CardTitle className="text-sm font-medium">Days Absent</CardTitle>
            <AlertTriangle className="h-4 w-4 text-red-600" />
          </CardHeader>
          <CardContent>
            <div className="text-2xl font-bold">{attendanceStats.daysAbsent}</div>
          </CardContent>
        </Card>
        <Card className="">
          <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
            <CardTitle className="text-sm font-medium">Days Late</CardTitle>
            <Clock className="h-4 w-4 text-yellow-600" />
          </CardHeader>
          <CardContent>
            <div className="text-2xl font-bold">{attendanceStats.daysLate}</div>
          </CardContent>
        </Card>
        <Card className="">
          <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
            <CardTitle className="text-sm font-medium">Avg. Check-in</CardTitle>
            <CalendarIcon className="h-4 w-4 text-muted-foreground" />
          </CardHeader>
          <CardContent>
            <div className="text-2xl font-bold">{attendanceStats.averageCheckInTime}</div>
          </CardContent>
        </Card>
      </div>

      {/* Attendance Calendar and Details */}
      <div className="grid gap-8 md:grid-cols-2">
        {/* Attendance Calendar */}
        <Card className="h-[30%] ">
          <CardHeader>
            <CardTitle>Attendance Calendar</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="grid grid-cols-7 gap-2">
              {['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].map(day => (
                <div key={day} className="text-center font-medium text-sm">{day}</div>
              ))}
              {calendarData.map((day, index) => (
                <div 
                  key={index}
                  className={`aspect-square flex items-center justify-center rounded-full text-sm
                    ${
                      day.status === 'present' ? 'bg-green-100 text-green-800' :
                      day.status === 'absent' ? 'bg-red-100 text-red-800' :
                      day.status === 'late' ? 'bg-yellow-100 text-yellow-800' :
                      'bg-gray-100'
                    }`}
                >
                  {day.date}
                </div>
              ))}
            </div>
          </CardContent>
        </Card>

        {/* Attendance Details Table */}
{/* Suggested code may be subject to a license. Learn more: ~LicenseLog:2511713332. */}
        <Card className="h-[30%] ">
  <CardHeader >
    <CardTitle>Attendance Details</CardTitle>
  </CardHeader>
  <CardContent className="overflow-auto h-[85%]" > 
    <Table className="relative">
      <TableHeader className="sticky top-0 bg-white z-10">
        <TableRow>
          <TableHead>Date</TableHead>
          <TableHead>Check In</TableHead>
          <TableHead>Check Out</TableHead>
          <TableHead>Status</TableHead>
        </TableRow>
      </TableHeader>
      <TableBody>
        {attendanceData.map((record, index) => (
          <TableRow key={index}>
            <TableCell>{record.date}</TableCell>
            <TableCell>{record.checkIn}</TableCell>
            <TableCell>{record.checkOut}</TableCell>
            <TableCell>
              <Badge
                variant={
                  record.status === 'Present' ? 'default' :
                  record.status === 'Late' ? 'warning' :
                  'destructive'
                }
              >
                {record.status}
              </Badge>
            </TableCell>
          </TableRow>
        ))}
      </TableBody>
    </Table>
  </CardContent>
</Card>

      </div>
    </div>
  );
};

export default IndividualAttendanceReport;
,
import React, { useState, useEffect } from "react";
import { useNavigate } from "react-router-dom";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from "@/components/ui/table";
import { Badge } from "@/components/ui/badge";
import { Users, UserCheck, Clock, XCircle } from "lucide-react";
import { supabase } from "../supabase";
import NotificationDropdown from "./NotificationDropdown";
import { format } from "date-fns";

const Attendance = () => {
  const [attendanceData, setAttendanceData] = useState([]);
  const [totalStaff, setTotalStaff] = useState(0);
  const [present, setPresent] = useState(0);
  const [absent, setAbsent] = useState(0);
  const [late, setLate] = useState(0);
  const navigate = useNavigate();

  const officeStartTime = "10:00";
  const officeEndTime = "18:30";

  useEffect(() => {
    fetchAttendanceData();
  }, []);

  const fetchAttendanceData = async () => {
    const today = new Date().toISOString().split("T")[0];

    // Fetch staff data
    const { data: staffData, error: staffError } = await supabase.from("staff").select("*");
    if (staffError) {
      console.error("Error fetching staff data:", staffError);
      return;
    }

    // Fetch today's attendance data
    const { data: attendanceData, error: attendanceError } = await supabase
      .from("attendance")
      .select("staff_id, date, time")
      .eq("date", today);
    if (attendanceError) {
      console.error("Error fetching attendance data:", attendanceError);
      return;
    }

    // Create a staff map for attendance
    const staffMap = staffData.reduce((acc, staff) => {
      acc[staff.id] = { id: staff.id, name: staff.name, status: "Absent", checkIn: "-", checkOut: "-" };
      return acc;
    }, {});

    // Process attendance data
    attendanceData.forEach((record) => {
      const checkInTime = record.time;
      const status = checkInTime <= officeStartTime ? "Present" : "Late";

      if (!staffMap[record.staff_id].checkIn || staffMap[record.staff_id].checkIn === "-") {
        staffMap[record.staff_id].checkIn = checkInTime;
        staffMap[record.staff_id].status = status;
      } else {
        staffMap[record.staff_id].checkOut = checkInTime;
      }
    });

    const staffList = Object.values(staffMap);
    const presentCount = staffList.filter((staff) => staff.status === "Present").length;
    const lateCount = staffList.filter((staff) => staff.status === "Late").length;
    const absentCount = staffList.filter((staff) => staff.status === "Absent").length;

    // Update state
    setAttendanceData(staffList);
    setTotalStaff(staffData.length);
    setPresent(presentCount);
    setLate(lateCount);
    setAbsent(absentCount);
  };

  // Handle navigating to individual attendance page
  const handleStaffClick = (staffId) => {
    navigate(`/home/attendance/${staffId}`); // Pass staffId to the individual attendance page
  };

  return (
    <div className="container ">
      <div className="flex justify-between items-center mb-4">
        <h1 className="text-2xl font-bold">Staff Attendance Report</h1>
        <NotificationDropdown />
      </div>

      <div className="grid gap-4 md:grid-cols-2 lg:grid-cols-4 mb-4">
        {/* Total Employees */}
        <Card>
          <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
            <CardTitle className="text-sm font-medium">Total Employees</CardTitle>
            <Users className="h-4 w-4 text-muted-foreground" />
          </CardHeader>
          <CardContent>
            <div className="text-2xl font-bold">{totalStaff}</div>
          </CardContent>
        </Card>

        {/* Present Employees */}
        <Card>
          <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
            <CardTitle className="text-sm font-medium">Present</CardTitle>
            <UserCheck className="h-4 w-4 text-green-600" />
          </CardHeader>
          <CardContent>
            <div className="text-2xl font-bold">{present}</div>
          </CardContent>
        </Card>

        {/* Late Employees */}
        <Card>
          <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
            <CardTitle className="text-sm font-medium">Late</CardTitle>
            <Clock className="h-4 w-4 text-yellow-600" />
          </CardHeader>
          <CardContent>
            <div className="text-2xl font-bold">{late}</div>
          </CardContent>
        </Card>

        {/* Absent Employees */}
        <Card>
          <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
            <CardTitle className="text-sm font-medium">Absent</CardTitle>
            <XCircle className="h-4 w-4 text-red-600" />
          </CardHeader>
          <CardContent>
            <div className="text-2xl font-bold">{absent}</div>
          </CardContent>
        </Card>
      </div>

      {/* Attendance Details Table */}
      <Card>
        <CardHeader>
          <CardTitle>Attendance Details</CardTitle>
        </CardHeader>
        <CardContent>
          <Table>
            <TableHeader>
              <TableRow>
                <TableHead>Name</TableHead>
                <TableHead>Date</TableHead>
                <TableHead>Check In</TableHead>
                <TableHead>Check Out</TableHead>
                <TableHead>Status</TableHead>
              </TableRow>
            </TableHeader>
            <TableBody>
              {attendanceData.map((record) => (
                <TableRow
                  key={record.id}
                  onClick={() => handleStaffClick(record.id)} // Click handler to navigate to individual attendance
                  className="cursor-pointer hover:bg-gray-100"
                >
                  <TableCell className="font-medium">{record.name}</TableCell>
                  <TableCell>{format(new Date(), "yyyy-MM-dd")}</TableCell>
                  <TableCell>{record.checkIn}</TableCell>
                  <TableCell>{record.checkOut}</TableCell>
                  <TableCell>
                    <Badge
                      variant={
                        record.status === "Present"
                          ? "default"
                          : record.status === "Late"
                          ? "warning"
                          : "destructive"
                      }
                    >
                      {record.status}
                    </Badge>
                  </TableCell>
                </TableRow>
              ))}
            </TableBody>
          </Table>
        </CardContent>
      </Card>
    </div>
  );
};

export default Attendance;
,
